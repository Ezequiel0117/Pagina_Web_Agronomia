{% load static %}
<!DOCTYPE html>
<html lang="es">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Mercado Sostenible{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="{% static 'style.css' %}" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
   href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
   rel="stylesheet"
  />
  <script>
   tailwind.config = {
    theme: {
     extend: {
      colors: {
       "forest-green": "#2B601E",
       "earth-taupe": "#A88D66",
       "leaf-green": "#91D956",
       "sky-blue": "#A1C8E8",
       "golden-harvest": "#D1A24E",
      },
     },
    },
      };
    </script>
  </head>
  <body class="flex flex-col min-h-screen font-sans">  <header class="navbar-blur bg-forest-green text-white shadow-2xl sticky top-0 z-50 bg-opacity-95 backdrop-blur-md">
   <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
    <div class="logo-animate">
     <a href="/" class="text-2xl md:text-3xl font-bold flex items-center gap-2 hover:text-leaf-green transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      Mercado Sostenible
     </a>
    </div>
    <div class="hidden md:flex space-x-6 lg:space-x-8">
     <a href="#productos-acuicolas" class="text-base lg:text-lg font-medium hover:text-golden-harvest transition-all"> Acu铆colas</a>
     <a href="#productos-pesqueros" class="text-base lg:text-lg font-medium hover:text-golden-harvest transition-all"> Pesqueros</a>
     <a href="#productos-ganaderos" class="text-base lg:text-lg font-medium hover:text-golden-harvest transition-all">ォ Ganaderos</a>
     <a href="#productos-vegetales" class="text-base lg:text-lg font-medium hover:text-golden-harvest transition-all">ガ Vegetales</a>
    </div>
    <div class="flex items-center gap-4">
     {% if user.is_authenticated %}
     <div class="relative">
      <button id="user-menu-button" class="flex items-center gap-2 bg-white text-forest-green font-semibold px-4 py-2 rounded-full shadow hover:scale-105 transition">
       <span class="hidden sm:inline">{{ user.username }}</span>
       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
      <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-xl rounded-lg py-2 border border-gray-100 animate-[fadeIn_0.2s_ease-out]">
       <a href="{% url 'perfil' %}" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Perfil</a>
       <a href="{% url 'logout' %}" class="block px-4 py-2 text-red-600 hover:bg-red-50">Cerrar sesi贸n</a>
      </div>
     </div>
     {% else %}
     <a href="{% url 'login' %}" class="hidden sm:inline-block bg-white text-forest-green font-bold px-6 py-2 rounded-full shadow hover:bg-gray-100 transition">Ingresar</a>
     {% endif %}
     <div class="md:hidden">
      <button id="mobile-menu-button" class="text-white p-2">
       <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
      </button>
     </div>
    </div>
   </nav>
   <div id="mobile-menu" class="hidden md:hidden bg-forest-green border-t border-white/10 px-6 py-4 space-y-4">
     <a href="#productos-acuicolas" class="block text-white"> Acu铆colas</a>
     <a href="#productos-pesqueros" class="block text-white"> Pesqueros</a>
     <a href="#productos-ganaderos" class="block text-white">ォ Ganaderos</a>
     <a href="#productos-vegetales" class="block text-white">ガ Vegetales</a>
   </div>
  </header>

  <main class="flex-grow bg-gray-50">
    {% block content %} {% endblock %}
  </main>

  <footer class="bg-gray-900 text-gray-300 py-12 mt-auto">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <div>
          <h3 class="text-xl font-bold text-white mb-4">Mercado Sostenible</h3>
          <p class="text-gray-400">Conectando productores locales con consumidores conscientes. Productos frescos y sostenibles.</p>
        </div>
        <div>
          <h3 class="text-xl font-bold text-white mb-4">Enlaces R谩pidos</h3>
          <ul class="space-y-2">
            <li><a href="#productos-acuicolas" class="text-gray-400 hover:text-white transition-colors">Productos Acu铆colas</a></li>
            <li><a href="#productos-pesqueros" class="text-gray-400 hover:text-white transition-colors">Productos Pesqueros</a></li>
            <li><a href="#productos-ganaderos" class="text-gray-400 hover:text-white transition-colors">Productos Ganaderos</a></li>
            <li><a href="#productos-vegetales" class="text-gray-400 hover:text-white transition-colors">Productos Vegetales</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold text-white mb-4">Contacto</h3>
          <p class="text-gray-400 mb-2"> info@mercadosostenible.com</p>
          <p class="text-gray-400 mb-2"> +593 123 456 789</p>
          <p class="text-gray-400"> Milagro, Guayas, Ecuador</p>
        </div>
      </div>
      <div class="border-t border-gray-700 pt-6 text-center">
        <p>&copy; 2025 Mercado de Producci贸n Sostenible. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <button
   id="chat-toggle-button"
   class="fixed bottom-6 right-6 bg-gradient-to-br from-forest-green to-leaf-green text-white p-4 rounded-full shadow-2xl hover:scale-110 transition-all duration-300 focus:outline-none z-40"
  >
   <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
   </svg>
  </button>

  <div
   id="chat-window"
   class="fixed bottom-24 right-6 w-[90%] md:w-96 h-[500px] max-h-[80vh] bg-white rounded-2xl shadow-2xl hidden flex-col z-50 border border-gray-200 overflow-hidden transition-all duration-300 origin-bottom-right"
  >
   <div class="bg-gradient-to-r from-forest-green to-leaf-green text-white p-4 flex justify-between items-center shadow-md">
    <div class="flex items-center gap-3">
      <div class="relative">
        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
         <span class="text-xl"></span>
        </div>
        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-forest-green rounded-full animate-pulse"></div>
      </div>
      <div>
        <h3 class="font-bold text-base">Asistente Virtual</h3>
        <p class="text-xs text-green-100">Responde al instante</p>
      </div>
    </div>
    <button id="chat-close-button" class="hover:bg-white/20 rounded-full p-1 transition">
     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
   </div>

   <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-4">
    </div>

   <div class="p-3 bg-white border-t border-gray-100">
    <div class="flex gap-2 items-center bg-gray-100 rounded-full px-4 py-2 focus-within:ring-2 focus-within:ring-leaf-green/30 transition-all">
      <input
        type="text"
        id="chat-input"
        placeholder="Escribe aqu铆..."
        class="flex-1 bg-transparent text-sm outline-none text-gray-700"
        autocomplete="off"
      />
      <button id="chat-send-button" class="text-forest-green hover:text-leaf-green transition-colors disabled:opacity-50" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
      </button>
    </div>
   </div>
  </div>

  <script>
   document.addEventListener("DOMContentLoaded", () => {
    // --- L贸gica Navbar (M贸vil y Usuario) ---
    const mobileMenuBtn = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const userMenuBtn = document.getElementById("user-menu-button");
    const userDropdown = document.getElementById("user-dropdown");

    if (mobileMenuBtn) mobileMenuBtn.addEventListener("click", () => mobileMenu.classList.toggle("hidden"));
    
    if (userMenuBtn && userDropdown) {
      userMenuBtn.addEventListener("click", (e) => { e.stopPropagation(); userDropdown.classList.toggle("hidden"); });
      document.addEventListener("click", (e) => { if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) userDropdown.classList.add("hidden"); });
    }

    // --- LGICA CHATBOT ---
    const chatToggleBtn = document.getElementById("chat-toggle-button");
    const chatWindow = document.getElementById("chat-window");
    const chatCloseBtn = document.getElementById("chat-close-button");
    const chatSendBtn = document.getElementById("chat-send-button");
    const chatInput = document.getElementById("chat-input");
    const chatMessages = document.getElementById("chat-messages");
    
    let isBotTyping = false;
    let hasWelcomed = false;

    // 1. Inicializaci贸n
    const initChat = () => {
      if (!hasWelcomed) {
        addBotMessage("隆Hola!  Bienvenido a Mercado Sostenible. 驴En qu茅 puedo ayudarte hoy?");
        showQuickReplies([
          " C贸mo comprar", 
          " Env铆os", 
          " Hablar con Asesor",
          " Ver precios"
        ]);
        hasWelcomed = true;
      }
    };

    // 2. Abrir/Cerrar
    chatToggleBtn.addEventListener("click", () => {
      chatWindow.classList.remove("hidden");
      chatWindow.classList.add("flex");
      chatToggleBtn.classList.add("hidden");
      initChat();
      setTimeout(() => chatInput.focus(), 100);
    });

    chatCloseBtn.addEventListener("click", () => {
      chatWindow.classList.add("hidden");
      chatWindow.classList.remove("flex");
      chatToggleBtn.classList.remove("hidden");
    });

    // 3. Manejo del Input
    chatInput.addEventListener("input", () => {
      chatSendBtn.disabled = chatInput.value.trim() === "";
    });

    // 4. Sistema de Mensajer铆a
    const handleUserMessage = (text) => {
      if (!text || isBotTyping) return;

      addUserMessage(text);
      chatInput.value = "";
      chatSendBtn.disabled = true;
      removeQuickReplies();

      isBotTyping = true;
      showTypingIndicator();

      setTimeout(() => {
        removeTypingIndicator();
        const response = getBotResponse(text);
        addBotMessage(response.text);
        if (response.suggestions) showQuickReplies(response.suggestions);
        isBotTyping = false;
      }, 1000); 
    };

    chatSendBtn.addEventListener("click", () => handleUserMessage(chatInput.value.trim()));
    chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") handleUserMessage(chatInput.value.trim()); });

    // 5. Funciones de UI
    const addUserMessage = (text) => {
      const div = document.createElement("div");
      div.className = "flex justify-end message-enter";
      div.innerHTML = `<div class="bg-forest-green text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[85%] text-sm shadow-sm">${text}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();
    };

    const addBotMessage = (text) => {
      const div = document.createElement("div");
      div.className = "flex justify-start message-enter";
      div.innerHTML = `<div class="bg-white border border-gray-200 text-gray-800 px-4 py-2 rounded-2xl rounded-tl-none max-w-[85%] text-sm shadow-sm leading-relaxed">${text}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();
    };

    const showQuickReplies = (options) => {
      const container = document.createElement("div");
      container.className = "flex flex-wrap gap-2 justify-start message-enter pl-1 quick-replies-container";
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "quick-reply-btn";
        btn.textContent = opt;
        btn.onclick = () => handleUserMessage(opt);
        container.appendChild(btn);
      });
      chatMessages.appendChild(container);
      scrollToBottom();
    };

    const removeQuickReplies = () => {
      const oldReplies = document.querySelectorAll('.quick-replies-container');
      oldReplies.forEach(el => el.remove()); 
    };

    const showTypingIndicator = () => {
      const div = document.createElement("div");
      div.id = "typing-indicator";
      div.className = "flex justify-start message-enter";
      div.innerHTML = `<div class="bg-gray-100 px-4 py-3 rounded-2xl rounded-tl-none"><div class="flex gap-1"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
      chatMessages.appendChild(div);
      scrollToBottom();
    };

    const removeTypingIndicator = () => {
      const indicator = document.getElementById("typing-indicator");
      if (indicator) indicator.remove();
    };

    const scrollToBottom = () => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // 6. CEREBRO DEL CHATBOT
    const getBotResponse = (input) => {
      const text = input.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      // --- ENVOS (NUEVO) ---
      if (text.includes("envio") || text.includes("domicilio") || text.includes("entregas") || text.includes("llevan")) {
        return {
          text: " **Env铆os y Entregas:**<br><br>Realizamos entregas a domicilio dentro del per铆metro urbano de **Milagro**. <br><br>Para otras zonas cercanas, por favor cont谩ctanos para coordinar.",
          suggestions: [" Hablar con Asesor", " Ver Ubicaci贸n"]
        };
      }

      // --- CONTACTO / ASESOR ---
      if (text.includes("contacto") || text.includes("asesor") || text.includes("telefono") || text.includes("correo") || text.includes("llamar")) {
        return {
          text: ` **Atenci贸n al Cliente:**<br><br>
             Haz clic abajo para contactarnos directamente:<br><br>
              <a href="mailto:info@mercadosostenible.com?subject=Consulta%20desde%20la%20Web" class="text-forest-green font-bold underline hover:text-leaf-green">Enviar Correo</a><br>
              <a href="tel:+593123456789" class="text-forest-green font-bold underline hover:text-leaf-green">+593 123 456 789</a><br><br>
             Estamos disponibles de 8:00 AM a 5:00 PM.`,
          suggestions: [" Ubicaci贸n", " Env铆os"]
        };
      }

      // --- CMO COMPRAR ---
      if (text.includes("comprar") || text.includes("pedido") || text.includes("adquirir")) {
        return {
          text: " **Pasos para comprar:**<br>1. Elige tus productos (Acu铆colas, Pesca, Carne o Vegetales).<br>2. Escr铆benos al correo o WhatsApp para confirmar stock.<br>3. Coordinamos el pago y env铆o.<br><br>隆Sencillo y r谩pido!",
          suggestions: [" Hablar con Asesor", " Ver Productos"]
        };
      }

      // --- UBICACIN ---
      if (text.includes("ubicacion") || text.includes("donde") || text.includes("direccion")) {
        return {
          text: " **Ubicaci贸n:**<br>Operamos en Milagro, Guayas. Conectamos a los productores de la zona directamente contigo.",
          suggestions: [" Env铆os", " Contacto"]
        };
      }

      // --- PRECIOS ---
      if (text.includes("precio") || text.includes("costo") || text.includes("vale")) {
        return {
          text: " **Precios Referenciales:**<br> Tilapia: $12.50/kg<br> Camar贸n: $14.00/kg<br>ォ Res: $9.75/kg<br>ガ Vegetales: Desde $3.50<br><br>驴Te interesa alguno en especial?",
          suggestions: [" Tilapia", "ォ Carne", " Cotizar con Asesor"]
        };
      }

      // --- PRODUCTOS ---
      if (text.includes("acuicola") || text.includes("tilapia") || text.includes("camaron")) {
        return { text: " Frescura garantizada. Nuestra Tilapia y Camar贸n son de producci贸n local controlada.", suggestions: [" Ver precio", " C贸mo comprar"] };
      }
      
      if (text.includes("vegetal") || text.includes("verdura")) {
        return { text: "ガ Vegetales 100% frescos, sin qu铆micos agresivos. Del campo a tu mesa.", suggestions: [" Ver precio", " C贸mo comprar"] };
      }

      if (text.includes("hola") || text.includes("buenas")) {
        return { text: "隆Hola!  驴En qu茅 te puedo ayudar hoy?", suggestions: [" Ver precios", " Env铆os"] };
      }

      if (text.includes("gracias") || text.includes("chao")) {
        return { text: "隆Gracias a ti!  Estamos para servirte.", suggestions: [] };
      }
      
      // --- FALLBACK ---
      return {
        text: "Entiendo.  Para darte una mejor respuesta, 驴prefieres ver los precios o hablar con alguien?",
        suggestions: [" Ver precios", " Hablar con Asesor"]
      };
    };

   });
  </script>
 </body>
</html>